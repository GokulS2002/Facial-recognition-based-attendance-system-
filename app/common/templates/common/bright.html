{% extends 'common/base.html' %}

{% block content %}
{% load static %}

<body id="id" class="app-blank" style="background-image: url('{% static "assets/media/demo/2600x1200/bg-10.png"%}');">
    <div class="flex" id="kt_app_root">
        <div class="d-flex flex-column flex-lg-row flex-column-fluid">
            <div class="d-flex flex-center flex-column flex-lg-row-fluid items-center justify-center mt-20">
                {% comment %} <canvas id="canvas" class=" rounded " style="transform: rotate(360deg) scaleX(-1);"></canvas> {% endcomment %}
                <!-- Main Card for Form -->
                <div class="card w-lg-400px p-10 position-relative">
               
                    
                    <form class="form w-100" novalidate="novalidate" id="employee_compare_form" method="POST" enctype="multipart/form-data" action="{% url 'employee_compare' %}">
                        {% csrf_token %}
                              {% comment %} <div class="video-container mb-8 mt-0">
                                <canvas id="canvas"  width="300" height="300"  class=" rounded " style="transform: rotate(360deg) scaleX(-1);"></canvas>
                                </div> {% endcomment %}
                       
                <video id="videoElement" autoplay playsinline muted style="height: 0.5px; width: 0.5px;"></video>
                <div class="screenratio">   
                    
                    <canvas id="canvasElement" style="transform: rotate(360deg) scaleX(-1);"></canvas>
                </div>

                        <input type="hidden" name="captured_image" id="captured_image">
                        
                        <div class="fv-row mb-10">
                            <input type="tel" autocomplete="off" class="round-small" id="form2a" value=""
                            placeholder="Enter mobile number to mark attendance." maxlength="10"
                            style="border: solid 1px rgba(0,0,0,.1);  border-radius: 10px; padding-left: 8px;">
                        <label for="form2a" class="color-highlight">Mobile</label>
                        <em class="require" style="display: block;">(required)</em>
                        <p id="errorMessage" style="color: red;"></p>
                        <input type="hidden" name="phone" id="phone">
                        </div>

                        <div class="d-grid mb-10">
                            <button type="button"  id="kt_docs_formvalidation_text_submit" class="btn btn-primary" onclick="handleSubmitForm()">
                                <span class="indicator-label">Submit</span>
                                <span class="indicator-progress">Please wait... <span class="spinner-border spinner-border-sm align-middle ms-2"></span></span>
                            </button>
                        </div>

                        <div class="text-gray-500 text-center fw-semibold fs-6">
                            <a href="{% url 'employee_signup' %}" class="link-primary fw-semibold hover-input">Signup as Employee</a>
                        </div>
                    </form>

                    
                    <div id="comparisonModal" class="position-absolute bottom-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-dark bg-opacity-50 text-white d-none" style="z-index: 10;">
                        <div id="modalContent" class="bg-white rounded p-5 shadow text-center" style="width: 80%; max-width: 350px;">
                            <div id="modalIcon" class="fs-1"></div>
                            <h5 id="modalTitle" class="fw-bold mt-3 "></h5>
                            <p id="modalMessage" class="fs-6 fw-semibold text-gray-700 mt-2"></p>
                            <button type="button" class="btn btn-light mt-4" onclick="closeModal()">Close</button>
                        </div>
                    </div>
                  
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Animation for the modal sliding up */
        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Modal content animation */
        #modalContent {
            animation: slideUp 0.5s ease-out;
        }
    </style>

    <script>
        {% comment %} const canvas = document.getElementById("canvas");
        const context = canvas.getContext("2d");
       // context.fillrect (100, 100, 75, 100);
        // Initialize the video stream
        navigator.mediaDevices.getUserMedia({ video: true })
            .then((stream) => {
                const video = document.createElement("video");
                video.srcObject = stream;
                video.play();

              
                video.addEventListener("loadedmetadata", () => {
                  
                    drawVideoToCanvas(video);
                });
            })
            .catch((err) => {
                console.warn("Camera access denied or unavailable: ", err);
                context.fillText("Camera not available.", 10, 50);
            });

        function drawVideoToCanvas(video) {
            function render() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    context.drawImage(video, 0, 0,350,400);
                }
                requestAnimationFrame(render);
            }
            render();
        } {% endcomment %}
          
            const video = document.getElementById("videoElement");
            const canvas = document.getElementById("canvasElement");
            const ctx = canvas.getContext("2d");
            var context = canvas.getContext('2d');
         
            async function setupWebcam(video) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: true
                    });
                    video.srcObject = stream;
                } catch (error) {
                    console.error('Error accessing webcam:', error);
                }
            }
            setupWebcam(video);
            video.addEventListener('play', () => processFrame(video, canvas));
        function processFrame(video, canvas) {
            const ctx = canvas.getContext('2d');
            const aspectRatio = 4 / 3;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const hi = (window.innerHeight * 40) / 100;
            canvas.height = window.innerHeight - hi;
            canvas.width = (window.innerHeight - hi) * aspectRatio;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const averageBrightness = analyzeImage(imageData);
            const adjustmentFactor = calculateAdjustmentFactor(averageBrightness); // Define this function
            for (let i = 0; i < imageData.data.length; i += 4) {
                imageData.data[i] *= adjustmentFactor; // Adjust red channel
                imageData.data[i + 1] *= adjustmentFactor; // Adjust green channel
                imageData.data[i + 2] *= adjustmentFactor; // Adjust blue channel
            }
            ctx.putImageData(imageData, 0, 0);
            requestAnimationFrame(() => processFrame(video, canvas));
            ctx.font = '13px calibri';
            ctx.fillStyle = 'red';
        
            const textYPosition = canvas.height - 50; // 20 is an arbitrary padding from the bottom
           
           
          
    
        }
        function analyzeImage(imageData) {
            const data = imageData.data;
            let totalBrightness = 0;
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const brightness = (r + g + b) / 3;
                totalBrightness += brightness;
            }
            const averageBrightness = totalBrightness / (data.length / 4); //Average brightness set
            return averageBrightness;
        }
    
        function calculateAdjustmentFactor(averageBrightness) {
            const minBrightness = 0; // Minimum brightness value
            const maxBrightness = 255; // Maximum brightness value
            const minFactor = 0.5; // Minimum adjustment factor
            const maxFactor = 1.5; // Maximum adjustment factor
            const normalizedBrightness = (averageBrightness - minBrightness) / (maxBrightness - minBrightness);
            const adjustmentFactor = (maxFactor - minFactor) * normalizedBrightness + minFactor;
            return adjustmentFactor;
        }

        function handleSubmitForm() {
            // Capture image from canvas
            const dataUrl = canvas.toDataURL("image/png");
            document.getElementById("captured_image").value = dataUrl;

            // Simulate server-side face comparison response
            const employeeFound = simulateFaceComparison();

            // Get modal elements
            const modal = document.getElementById('comparisonModal');
            const modalIcon = document.getElementById('modalIcon');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');

            
            if (employeeFound) {
                modalIcon.innerHTML = `<i class="bi bi-check-circle-fill text-success"></i>`;
                modalTitle.textContent = "Comparison Successful!";
                modalMessage.textContent = "Face matched successfully. Employee found.";
            } else {
                modalIcon.innerHTML = `<i class="bi bi-exclamation-triangle-fill text-danger"></i>`;
                modalTitle.textContent = "Face Not Found";
                modalMessage.textContent = "No matching employee found. Please try again.";
            }

            
            modal.classList.remove('d-none');
        }

        function closeModal() {
            document.getElementById('comparisonModal').classList.add('d-none');
        }

        
        function simulateFaceComparison() {
        
            return Math.random() > 0.5;
        }
        // Define form element
const form = document.getElementById('kt_docs_formvalidation_text');

// Init form validation rules. For more info check the FormValidation plugin's official documentation:https://formvalidation.io/
var validator = FormValidation.formValidation(
    form,
    {
        fields: {
            'phone': {
                validators: {
                    notEmpty: {
                        message: 'Phone number is required'
                    }
                }
            },
        },

        plugins: {
            trigger: new FormValidation.plugins.Trigger(),
            bootstrap: new FormValidation.plugins.Bootstrap5({
                rowSelector: '.fv-row',
                eleInvalidClass: '',
                eleValidClass: ''
            })
        }
    }
);

// Submit button handler
const submitButton = document.getElementById('kt_docs_formvalidation_text_submit');
submitButton.addEventListener('click', function (e) {
    // Prevent default button action
    e.preventDefault();

    // Validate form before submit
    if (validator) {
        validator.validate().then(function (status) {
            console.log('validated!');

            if (status == 'Valid') {
                // Show loading indication
                submitButton.setAttribute('data-kt-indicator', 'on');

                
                submitButton.disabled = true;

               
                setTimeout(function () {
                    
                    submitButton.removeAttribute('data-kt-indicator');

                    
                    submitButton.disabled = false;

                  
                    Swal.fire({
                        text: "Form has been successfully submitted!",
                        icon: "success",
                        buttonsStyling: false,
                        confirmButtonText: "Ok, got it!",
                        customClass: {
                            confirmButton: "btn btn-primary"
                        }
                    });

                    
                }, 2000);
            }
        });
    }
});
    </script>
</body>
{% endblock %}
